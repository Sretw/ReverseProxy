# ------------------------------------------------------------
# netbird.sretw.com
# DO NOT EDIT THIS FILE DIRECTLY, CHANGES WILL BE LOST WHEN UPDATING!
# ------------------------------------------------------------


server {
    set $forward_scheme "http";
    set $server "netbird-dashboard";
    set $port "80";
    set $forward_path "";


    listen 0.0.0.0:80;
    listen [::]:80;


    listen 0.0.0.0:443 ssl;
    listen [::]:443 ssl;


    server_name netbird.sretw.com;


    # Certbot TLS
    ssl_certificate /data/tls/certbot/live/npm-7/fullchain.pem;
    ssl_certificate_key /data/tls/certbot/live/npm-7/privkey.pem;


    include conf.d/include/hsts.conf;


    # Force HTTPS
    include conf.d/include/force-https.conf;


    include conf.d/include/always.conf;


    listen 33080 ssl;

    location /signalexchange.SignalExchange/ {
        if ($http_content_type = "application/grpc") {
            grpc_pass grpc://netbird-signal:80;
        }
        proxy_pass http://netbird-signal:80;
        grpc_read_timeout 1d;
        grpc_send_timeout 1d;
        grpc_socket_keepalive on;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /management.ManagementService/ {
        if ($http_content_type = "application/grpc") {
            grpc_pass grpc://netbird-management:443;
        }
        proxy_pass http://netbird-management:443;
        grpc_read_timeout 1d;
        grpc_send_timeout 1d;
        grpc_socket_keepalive on;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /ws-proxy/signal {
        proxy_pass http://netbird-signal:80;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /ws-proxy/management {
        proxy_pass http://netbird-management:443;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api {
        proxy_pass http://netbird-management:443;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /relay {
        proxy_pass http://netbird-relay:33080;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }


    location / {

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;


        include conf.d/include/proxy-headers.conf;
        proxy_pass http://netbird-dashboard:80$request_uri;

    }


    # custom locations
    # Custom
    include /data/custom_nginx/server_proxy.conf;
}

